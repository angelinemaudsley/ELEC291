0000              1   ; N76E003 LCD_Pushbuttons.asm: Reads muxed push buttons using one input
0000              2   
                  4   $LIST
0000              6   
0000              7   ;  N76E003 pinout:
0000              8   ;                               -------
0000              9   ;       PWM2/IC6/T0/AIN4/P0.5 -|1    20|- P0.4/AIN5/STADC/PWM3/IC3
0000             10   ;               TXD/AIN3/P0.6 -|2    19|- P0.3/PWM5/IC5/AIN6
0000             11   ;               RXD/AIN2/P0.7 -|3    18|- P0.2/ICPCK/OCDCK/RXD_1/[SCL]
0000             12   ;                    RST/P2.0 -|4    17|- P0.1/PWM4/IC4/MISO
0000             13   ;        INT0/OSCIN/AIN1/P3.0 -|5    16|- P0.0/PWM3/IC3/MOSI/T1
0000             14   ;              INT1/AIN0/P1.7 -|6    15|- P1.0/PWM2/IC2/SPCLK
0000             15   ;                         GND -|7    14|- P1.1/PWM1/IC1/AIN7/CLO
0000             16   ;[SDA]/TXD_1/ICPDA/OCDDA/P1.6 -|8    13|- P1.2/PWM0/IC0
0000             17   ;                         VDD -|9    12|- P1.3/SCL/[STADC]
0000             18   ;            PWM5/IC7/SS/P1.5 -|10   11|- P1.4/SDA/FB/PWM1
0000             19   ;                               -------
0000             20   ;
0000             21   
0000             22   CLK               EQU 16600000 ; Microcontroller system frequency in Hz
0000             23   BAUD              EQU 115200 ; Baud rate of UART in bps
0000             24   TIMER1_RELOAD     EQU (0x100-(CLK/(16*BAUD)))
0000             25   TIMER0_RELOAD_1MS EQU (0x10000-(CLK/1000))
0000             26   TIMER2_RATE EQU 100 ; 100Hz or 10ms
0000             27   TIMER2_RELOAD EQU (65536-(CLK/(16*TIMER2_RATE))) ; Need to change timer 2 input divide to 16 in T2MOD
0000             28   
0000             29   ORG 0x0000
0000 020A0C      30            ljmp main
0023             31   org 0x0023
0023 32          32            reti
0024             33            ; Timer/Counter 2 overflow interrupt vector
002B             34   org 0x002B
002B 0204AE      35            ljmp Timer2_ISR
002E             36   
002E             37   START_BUTTON  equ P1.7
002E             38   PWM_OUT equ P1.0 ;logic 1 = oven on
002E             39   
002E             40   
002E             41   ;                   1234567890123456    <- This helps determine the location of the counter
002E 536F616B    42   soak_param: db     'Soak: xxs xxxC', 0
     3A207878
     73207878
     784300
003D 5265666C    43   reflow_param:db    'Reflow: xxs xxxC', 0
     6F773A20
     78787320
     78787843
     00
004E 54733A78    44   heating_to_s:  db   'Ts:xxxC To:xxxC', 0
     78784320
     546F3A78
     78784300
005E 54656D70    45   heating_temp:db    'Temp: ', 0;heating_temp:db    'Temp: xxxC', 0
     3A2000
0065 20202020    46   blank: db          '                ', 0 
     20202020
     20202020
     20202020
     00
0076 4552524F    47   safety_message:db  'ERROR: ', 0
     523A2000
007E 43616E74    48   safety_message1:db  'Cant Read Temp'
     20526561
     64205465
     6D70
008C 536F616B    49   soaking:db         'Soaking time:', 0
     696E6720
     74696D65
     3A00
009A 5265666C    50   reflow:db          'Reflow Time:',0
     6F772054
     696D653A
     00
00A7 54696D65    51   time:db            'Time:xxs',0
     3A787873
     00
00B0 54723A78    52   heating_to_r:db    'Tr:xxxC To:xxxC', 0
     78784320
     546F3A78
     78784300
00C0 436F6F6C    53   cooling:db         'Cooling down...', 0
     696E6720
     646F776E
     2E2E2E00
00D0             54   
00D0             55   cseg
00D0             56   ; These 'equ' must match the hardware wiring
00D0             57   LCD_RS equ P1.3
00D0             58   LCD_E  equ P1.4
00D0             59   LCD_D4 equ P0.0
00D0             60   LCD_D5 equ P0.1
00D0             61   LCD_D6 equ P0.2
00D0             62   LCD_D7 equ P0.3
00D0             63   ;ADC_pn equ P1.1
00D0             64   
00D0             65   
                 67   	$LIST
01C2             69   
0030             70   DSEG at 30h
0030             71   STATE: ds 1
0031             72   Soak_time: ds 1
0032             73   Soak_temp: ds 1
0033             74   soak_temp_hund: ds 1
0034             75   Reflow_time: ds 1
0035             76   Reflow_temp: ds 1
0036             77   current_temp: ds 1
0037             78   current_temp_hund: ds 1
0038             79   outside_temp: ds 1
0039             80   seconds: ds 1 ;seconds counter attached to timer 2 ISR
003A             81   pwm_counter: ds 1 ; Free running counter 0, 1, 2, ..., 100, 0
003B             82   pwm: ds 1 ; pwm percentage
003C             83   reflow_temp_100:ds 1
003D             84   x: ds 4
0041             85   y: ds 4
0045             86   z: ds 4
0049             87   bcd: ds 5
004E             88   
004E             89   
0000             90   BSEG
0000             91   ; These five bit variables store the value of the pushbuttons after calling 'LCD_PB' below
0000             92   PB0: dbit 1
0001             93   PB1: dbit 1
0002             94   PB2: dbit 1
0003             95   PB3: dbit 1
0004             96   PB4: dbit 1
0005             97   decrement1: dbit 1
0006             98   s_flag: dbit 1 ; set to 1 every time a second has passed
0007             99   mf: dbit 1
0008            100   temp_flag: dbit 1
0009            101   
                546   $LIST
                103   $LIST
0432            105   
0432            106   CSEG
0432            107   
0432            108   Init_All:
0432            109            ; Configure all the pins for biderectional I/O
0432 75AC00     110            mov     P3M1, #0x00
0435 75AD00     111            mov     P3M2, #0x00
0438 75B300     112            mov     P1M1, #0x00
043B 75B400     113            mov     P1M2, #0x00
043E 75B100     114            mov     P0M1, #0x00
0441 75B200     115            mov     P0M2, #0x00
0444            116            
0444 438E10     117            orl     CKCON, #0x10 ; CLK is the input for timer 1
0447 438780     118            orl     PCON, #0x80 ; Bit SMOD=1, double baud rate
044A 759852     119            mov     SCON, #0x52
044D 53C4DF     120            anl     T3CON, #0b11011111
0450 53890F     121            anl     TMOD, #0x0F ; Clear the configuration bits for timer 1
0453 438920     122            orl     TMOD, #0x20 ; Timer 1 Mode 2
0456 758DF7     123            mov     TH1, #TIMER1_RELOAD ; TH1=TIMER1_RELOAD;
0459 D28E       124            setb TR1
045B            125            
045B            126            ; Using timer 0 for delay functions.  Initialize here:
045B C28C       127            clr     TR0 ; Stop timer 0
045D 438E08     128            orl     CKCON,#0x08 ; CLK is the input for timer 0
0460 5389F0     129            anl     TMOD,#0xF0 ; Clear the configuration bits for timer 0
0463 438901     130            orl     TMOD,#0x01 ; Timer 0 in Mode 1: 16-bit timer
0466            131   
0466            132            ; Initialize timer 2 for periodic interrupts
0466 75C800     133            mov T2CON, #0 ; Stop timer/counter. Autoreload mode.
0469 75CDD7     134            mov TH2, #high(TIMER2_RELOAD)
046C 75CC79     135            mov TL2, #low(TIMER2_RELOAD)
046F            136            ; Set the reload value
046F 75C9A0     137            mov T2MOD, #0b1010_0000 ; Enable timer 2 autoreload, and clock divider is 16
0472 75CBD7     138            mov RCMP2H, #high(TIMER2_RELOAD)
0475 75CA79     139            mov RCMP2L, #low(TIMER2_RELOAD)
0478            140            ; Init the free running 10 ms counter to zero
0478 753A00     141            mov pwm_counter, #0
047B            142            ; Enable the timer and interrupts
047B 439B80     143            orl EIE, #0x80 ; Enable timer 2 interrupt ET2=1
047E D2CA       144            setb TR2 ; Enable timer 2
0480 D2AF       145            setb EA ; Enable global interrupts
0482            146   
0482            147            ; Initialize the pin used by the ADC-LM335 (P1.1) as input.
0482 43B302     148            orl     P1M1, #0b00000010
0485 53B4FD     149            anl     P1M2, #0b11111101
0488            150            
0488            151       ;initialize the pint used by ADC-opamp output as input pin 1 (P0.5) AIN4
0488 43B110     152       orl  P0M1, #0b00010000
048B 53B2EF     153            anl     P0M2, #0b11101111
048E            154            
048E            155   
048E            156            ; Initialize and start the ADC-LM335:
048E            157            ;do these two when you are going to read from pin 14
048E            158       ;anl ADCCON0, #0xF0
048E            159            ;orl ADCCON0, #0x07 ; Select channel 7
048E            160            
048E            161       ; AINDIDS select if some pins are analog inputs or digital I/O:
048E 75F600     162            mov AINDIDS, #0x00 ; Disable all analog inputs
0491 43F690     163            orl AINDIDS, #0b10010000 ; P1.1 and P0.5 is analog input
0494 43E101     164            orl ADCCON1, #0x01 ; Enable ADC
0497            165   
0497            166   
0497 22         167   ret
0498            168            
0498            169   wait_1ms:
0498 C28C       170            clr     TR0 ; Stop timer 0
049A C28D       171            clr     TF0 ; Clear overflow flag
049C 758CBF     172            mov     TH0, #high(TIMER0_RELOAD_1MS)
049F 758A28     173            mov     TL0,#low(TIMER0_RELOAD_1MS)
04A2 D28C       174            setb TR0
04A4 308DFD     175            jnb     TF0, $ ; Wait for overflow
04A7 22         176            ret
04A8            177   
04A8            178   ; Wait the number of miliseconds in R2
04A8            179   waitms:
04A8 120498     180            lcall wait_1ms
04AB DAFB       181            djnz R2, waitms
04AD 22         182            ret
04AE            183   
04AE            184   Timer2_ISR:
04AE C2CF       185            clr TF2 ; Timer 2 doesn't clear TF2 automatically. Do it in the ISR. It is bit addressable.
04B0 C0D0       186            push psw
04B2 C0E0       187            push acc
04B4            188   
04B4 053A       189            inc pwm_counter
04B6 C3         190            clr c
04B7 E53B       191            mov a, pwm
04B9 953A       192            subb a, pwm_counter ; If pwm_counter <= pwm then c=1
04BB B3         193            cpl c
04BC 9290       194            mov PWM_OUT, c
04BE            195   
04BE E53A       196            mov a, pwm_counter
04C0 B46407     197            cjne a, #100, Timer2_ISR_done
04C3 753A00     198            mov pwm_counter, #0
04C6 0539       199            inc seconds ; It is super easy to keep a seconds count here
04C8 D206       200            setb s_flag
04CA            201   
04CA            202   Timer2_ISR_done:
04CA D0E0       203            pop acc
04CC D0D0       204            pop psw
04CE 32         205            reti
04CF            206   
04CF            207   LCD_PB:
04CF            208            ; Set variables to 1: 'no push button pressed'
04CF D200       209            setb PB0
04D1 D201       210            setb PB1
04D3 D202       211            setb PB2
04D5 D203       212            setb PB3
04D7 D204       213            setb PB4
04D9            214            ; The input pin used to check set to '1'
04D9 D295       215            setb P1.5
04DB            216            
04DB            217            ; Check if any push button is pressed
04DB C280       218            clr P0.0
04DD C281       219            clr P0.1
04DF C282       220            clr P0.2
04E1 C283       221            clr P0.3
04E3 C293       222            clr P1.3
04E5 209544     223            jb P1.5, LCD_PB_Done
04E8            224   
04E8            225            ; Debounce
04E8 209541     226            jb P1.5, LCD_PB_Done
04EB C002       227            push AR2
04ED 7A32       227            mov R2, #50
04EF 1200DA     227            lcall ?Wait_Milli_Seconds
04F2 D002       227            pop AR2
04F4 209535     228            jb P1.5, LCD_PB_Done
04F7 2095FD     229            jb P1.5, $
04FA            230   
04FA            231            ; Set the LCD data pins to logic 1
04FA D280       232            setb P0.0
04FC D281       233            setb P0.1
04FE D282       234            setb P0.2
0500 D283       235            setb P0.3
0502 D293       236            setb P1.3
0504            237            
0504            238            ; Check the push buttons one by one
0504 C293       239            clr P1.3
0506 A295       240            mov c, P1.5
0508 9204       241            mov PB4, c
050A D293       242            setb P1.3
050C            243   
050C C280       244            clr P0.0
050E A295       245            mov c, P1.5
0510 9203       246            mov PB3, c
0512 D280       247            setb P0.0
0514            248            
0514 C281       249            clr P0.1
0516 A295       250            mov c, P1.5
0518 9202       251            mov PB2, c
051A D281       252            setb P0.1
051C            253            
051C C282       254            clr P0.2
051E A295       255            mov c, P1.5
0520 9201       256            mov PB1, c
0522 D282       257            setb P0.2
0524            258            
0524 C283       259            clr P0.3
0526 A295       260            mov c, P1.5
0528 9200       261            mov PB0, c
052A D283       262            setb P0.3
052C            263   
052C            264   LCD_PB_Done:             
052C 22         265            ret
052D            266   
052D            267   check_decrement: 
052D 200005     268            jb PB0, check_stime
0530 B205       269            cpl decrement1
0532 020535     270            ljmp check_stime
0535            271   
0535            272   check_stime:
0535 200117     273            jb PB1, check_stemp
0538 20050A     274            jb decrement1, Soak_time_decrement
053B E531       275            mov a, Soak_time
053D 2401       276            add a, #0x01
053F D4         277            da a
0540 F531       278            mov Soak_time, a
0542 02054F     279            ljmp check_stemp
0545            280   
0545            281   Soak_time_decrement: 
0545 E531       282            mov a, Soak_time
0547 2499       283            add a, #0x99
0549 D4         284            da a
054A F531       285            mov Soak_time, a
054C 02054F     286            ljmp check_stemp
054F            287   
054F            288   check_stemp:
054F 200259     289            jb PB2, check_rtime
0552 200530     290            jb decrement1, Soak_temp_decrement
0555 E532       291            mov a, Soak_temp
0557 2401       292            add a, #0x01
0559 D4         293            da a
055A F532       294            mov Soak_temp, a
055C B49903     295       cjne a, #0x99, cont_s
055F 020579     296       ljmp add_hund_s
0562            297   
0562            298       cont_s:
0562 E533       299       mov a, soak_temp_hund
0564 B4200F     300            cjne a, #0x20, fini
0567 E532       301       mov a, Soak_temp
0569 B4503F     302       cjne a, #0x50, check_rtime
056C 7400       303            mov a, #0x00
056E F532       304            mov Soak_temp, a
0570 E533       305       mov a, soak_temp_hund
0572 7400       306       mov a, #0x00
0574 F533       307       mov soak_temp_hund, a
0576            308   
0576            309       fini:
0576 0205AB     310            ljmp check_rtime
0579            311   
0579            312   add_hund_s:
0579 E533       313       mov a, soak_temp_hund
057B 2410       314       add a, #0x10
057D D4         315       da A
057E F533       316       mov soak_temp_hund, A
0580 E532       317       mov a, Soak_temp
0582 020562     318       ljmp cont_s
0585            319   
0585            320   Soak_temp_decrement: 
0585 E532       321            mov a, Soak_temp
0587 2499       322            add a, #0x99
0589 D4         323            da a
058A F532       324            mov Soak_temp, a
058C B4001C     325       cjne a, #0x00, check_rtime
058F 0205A3     326       ljmp decrement_s_hund   
0592            327   
0592            328       continue_dec_s:
0592 753320     329       mov soak_temp_hund, #0x20
0595 753250     330       mov soak_temp, #0x50
0598 0205AB     331       ljmp check_rtime
059B            332   
059B            333       cont_s_dec:
059B 9410       334       SUBB a, #0x10
059D D4         335       da A
059E F533       336       mov soak_temp_hund, a 
05A0 0205AB     337            ljmp check_rtime
05A3            338   
05A3            339   decrement_s_hund:
05A3 E533       340       mov a, soak_temp_hund
05A5 B40069     341       cjne a , #0x00, cont_dec
05A8 020592     342       ljmp continue_dec_s
05AB            343   
05AB            344   check_rtime:
05AB 200317     345            jb PB3, check_rtemp 
05AE 20050A     346            jb decrement1, Reflow_time_decrement
05B1 E534       347            mov a, Reflow_time
05B3 2401       348            add a, #0x01
05B5 D4         349            da a
05B6 F534       350            mov Reflow_time, a
05B8 0205C5     351            ljmp check_rtemp
05BB            352   
05BB            353   Reflow_time_decrement: 
05BB E534       354            mov a, Reflow_time
05BD 2499       355            add a, #0x99
05BF D4         356            da a
05C0 F534       357            mov Reflow_time, a
05C2 0205C5     358            ljmp check_rtemp
05C5            359   
05C5            360   check_rtemp:
05C5 200459     361            jb PB4, skipp
05C8 200530     362            jb decrement1, Reflow_temp_decrement
05CB E535       363            mov a, Reflow_temp
05CD 2401       364            add a, #0x01
05CF D4         365       da a
05D0 F535       366       mov Reflow_temp, a
05D2 B49903     367            cjne a, #0x99, cont_r
05D5 0205EF     368       ljmp add_hundreds_r
05D8            369   
05D8            370       cont_r:
05D8            371       ;check hundreds
05D8 E53C       372       mov a, reflow_temp_100
05DA B4200F     373       cjne a, #0x20, cont_count ;make sure to check with 20 since the hundreds place value is multiplied by 10
05DD E535       374            mov a, reflow_temp
05DF B4503F     375       cjne a, #0x50, skipp
05E2 7400       376       mov a, #0x00
05E4 F535       377       mov reflow_temp, a
05E6 E53C       378       mov a, reflow_temp_100
05E8 7400       379       mov a, #0x00
05EA F53C       380            mov Reflow_temp_100, a
05EC            381       cont_count:
05EC 020621     382            ljmp skipp
05EF            383   
05EF            384   add_hundreds_r:
05EF E53C       385       mov a, reflow_temp_100
05F1 2410       386       add a, #0x10 ;add by ten bc in display it is 2 digit numbers so instead of showing 0120 for 120 itll show 120
05F3 D4         387       da A
05F4 F53C       388       mov reflow_temp_100, A
05F6 E535       389       mov a, Reflow_temp
05F8 0205D8     390       ljmp cont_r
05FB            391   
05FB            392   
05FB            393   Reflow_temp_decrement: 
05FB E535       394            mov a, Reflow_temp
05FD 2499       395            add a, #0x99
05FF D4         396            da a
0600 F535       397            mov Reflow_temp, a
0602 B4001C     398       cjne a, #0x00, skipp
0605 020619     399       ljmp decrement_r_hund
0608            400   
0608            401       continue_dec_r:
0608            402            ;mov a, reflow_temp
0608            403       ;cjne a, #0x00, skipp
0608 753550     404       mov reflow_temp, #0x50
060B 753C20     405       mov reflow_temp_100, #0x20
060E 020621     406       ljmp skipp
0611            407   
0611            408       cont_dec:
0611 9410       409       SUBB a, #0x10
0613 D4         410       da a
0614 F53C       411       mov reflow_temp_100, a
0616 020621     412            ljmp skipp
0619            413   
0619            414       decrement_r_hund:
0619 E53C       415       mov a, reflow_temp_100
061B B400F3     416       cjne a, #0x00, cont_dec
061E 020608     417       ljmp continue_dec_r
0621            418   
0621            419   skipp:
0621 22         420            ret
0622            421   
0622            422   Check_start:
0622 209713     423            jb START_BUTTON, smjmp  ; if the 'Start' button is not pressed skip
0625 C002       424            push AR2
0627 7A32       424            mov R2, #50
0629 1200DA     424            lcall ?Wait_Milli_Seconds
062C D002       424            pop AR2         ; Debounce delay.  This macro is also in 'LCD_4bit.inc'
062E 209707     425            jb  START_BUTTON, smjmp  ; if the 'Start' button is not pressed skip
0631 3097FD     426            jnb START_BUTTON, $             ; Wait for button release.  The '$' means: jump to same instruction.
0634 753001     427            mov STATE, #0x01
0637 22         428            ret
0638            429   
0638            430   smjmp:
0638 020621     431   ljmp skipp
063B            432   
063B            433   wait_for_ti:
063B 3099FD     434       jnb TI, wait_for_ti
063E C299       435       clr TI
0640 22         436       ret
0641            437   
0641            438   display_menu:
0641 C0E0       439            push acc
0643 7407       439            mov a, #7
0645 14         439            dec a
0646 120169     439            lcall ?Set_Cursor_1 ; Select column and row
0649 D0E0       439            pop acc 
064B C000       440            push ar0
064D A831       440            mov r0, Soak_time
064F 12016E     440            lcall ?Display_BCD
0652 D000       440            pop ar0
0654 C0E0       441            push acc
0656 740B       441            mov a, #11
0658 14         441            dec a
0659 120169     441            lcall ?Set_Cursor_1 ; Select column and row
065C D0E0       441            pop acc
065E            441   
065E C000       442            push ar0
0660 A833       442            mov r0, Soak_temp_hund
0662 12016E     442            lcall ?Display_BCD
0665 D000       442            pop ar0
0667 C0E0       443            push acc
0669 740C       443            mov a, #12
066B 14         443            dec a
066C 120169     443            lcall ?Set_Cursor_1 ; Select column and row
066F D0E0       443            pop acc
0671 C000       444            push ar0
0673 A832       444            mov r0, soak_temp
0675 12016E     444            lcall ?Display_BCD
0678 D000       444            pop ar0
067A C0E0       445            push acc
067C 7409       445            mov a, #9
067E 14         445            dec a
067F 120167     445            lcall ?Set_Cursor_2 ; Select column and row
0682 D0E0       445            pop acc
0684 C000       446            push ar0
0686 A834       446            mov r0, Reflow_time
0688 12016E     446            lcall ?Display_BCD
068B D000       446            pop ar0
068D C0E0       447            push acc
068F 740D       447            mov a, #13
0691 14         447            dec a
0692 120167     447            lcall ?Set_Cursor_2 ; Select column and row
0695 D0E0       447            pop acc
0697 C000       448            push ar0
0699 A83C       448            mov r0, reflow_temp_100
069B 12016E     448            lcall ?Display_BCD
069E D000       448            pop ar0
06A0 C0E0       449            push acc
06A2 740E       449            mov a, #14
06A4 14         449            dec a
06A5 120167     449            lcall ?Set_Cursor_2 ; Select column and row
06A8 D0E0       449            pop acc
06AA C000       450            push ar0
06AC A835       450            mov r0, reflow_temp
06AE 12016E     450            lcall ?Display_BCD
06B1 D000       450            pop ar0
06B3 22         451       ret
06B4            452   
06B4            453   display_heating_s:
06B4            454            ;Set_Cursor(1,4)
06B4            455            ;Display_BCD(Soak_temp_hund)
06B4            456            ;set_cursor(1,5)
06B4            457            ;display_bcd(soak_temp)
06B4 C0E0       458            push acc
06B6 740C       458            mov a, #12
06B8 14         458            dec a
06B9 120169     458            lcall ?Set_Cursor_1 ; Select column and row
06BC D0E0       458            pop acc
06BE C000       459            push ar0
06C0 A838       459            mov r0, outside_temp
06C2 12016E     459            lcall ?Display_BCD
06C5 D000       459            pop ar0
06C7 C0E0       460            push acc
06C9 7407       460            mov a, #7
06CB 14         460            dec a
06CC 120167     460            lcall ?Set_Cursor_2 ; Select column and row
06CF D0E0       460            pop acc
06D1 C000       461            push ar0
06D3 A836       461            mov r0, current_temp
06D5 12016E     461            lcall ?Display_BCD
06D8 D000       461            pop ar0
06DA 22         462            ret
06DB            463   
06DB            464   display_heating_r:
06DB C0E0       465            push acc
06DD 7404       465            mov a, #4
06DF 14         465            dec a
06E0 120169     465            lcall ?Set_Cursor_1 ; Select column and row
06E3 D0E0       465            pop acc
06E5 C000       466            push ar0
06E7 A83C       466            mov r0, reflow_temp_100
06E9 12016E     466            lcall ?Display_BCD
06EC D000       466            pop ar0
06EE C0E0       467            push acc
06F0 7405       467            mov a, #5
06F2 14         467            dec a
06F3 120169     467            lcall ?Set_Cursor_1 ; Select column and row
06F6 D0E0       467            pop acc
06F8 C000       468            push ar0
06FA A835       468            mov r0, reflow_temp
06FC 12016E     468            lcall ?Display_BCD
06FF D000       468            pop ar0
0701 C0E0       469            push acc
0703 740C       469            mov a, #12
0705 14         469            dec a
0706 120169     469            lcall ?Set_Cursor_1 ; Select column and row
0709 D0E0       469            pop acc
070B C000       470            push ar0
070D A838       470            mov r0, outside_temp
070F 12016E     470            lcall ?Display_BCD
0712 D000       470            pop ar0
0714 C0E0       471            push acc
0716 7407       471            mov a, #7
0718 14         471            dec a
0719 120167     471            lcall ?Set_Cursor_2 ; Select column and row
071C D0E0       471            pop acc
071E C000       472            push ar0
0720 A836       472            mov r0, current_temp
0722 12016E     472            lcall ?Display_BCD
0725 D000       472            pop ar0
0727 22         473            ret
0728            474   
0728            475   display_blank:
0728 C0E0       476            push acc
072A 7401       476            mov a, #1
072C 14         476            dec a
072D 120169     476            lcall ?Set_Cursor_1 ; Select column and row
0730 D0E0       476            pop acc
0732 C083       477            push dph
0734 C082       477            push dpl
0736 C0E0       477            push acc
0738 900065     477            mov dptr, #blank
073B 12015C     477            lcall ?Send_Constant_String
073E D0E0       477            pop acc
0740 D082       477            pop dpl
0742 D083       477            pop dph
0744 C0E0       478            push acc
0746 7401       478            mov a, #1
0748 14         478            dec a
0749 120167     478            lcall ?Set_Cursor_2 ; Select column and row
074C D0E0       478            pop acc
074E C083       479            push dph
0750 C082       479            push dpl
0752 C0E0       479            push acc
0754 900065     479            mov dptr, #blank
0757 12015C     479            lcall ?Send_Constant_String
075A D0E0       479            pop acc
075C D082       479            pop dpl
075E D083       479            pop dph
0760 22         480            ret
0761            481   
0761            482   Display_formated_BCD:
0761 C0E0       483            push acc
0763 740C       483            mov a, #12
0765 14         483            dec a
0766 120169     483            lcall ?Set_Cursor_1 ; Select column and row
0769 D0E0       483            pop acc
076B C000       484            push ar0
076D A84B       484            mov r0, bcd+2
076F 12016E     484            lcall ?Display_BCD
0772 D000       484            pop ar0
0774 C0E0       485            push acc
0776 742E       485            mov a, #'.'
0778 12011F     485            lcall ?WriteData
077B D0E0       485            pop acc
077D C000       486            push ar0
077F A84A       486            mov r0, bcd+1
0781 12016E     486            lcall ?Display_BCD
0784 D000       486            pop ar0
0786 22         487            ret
0787            488   
0787            489   conv_to_bcd_high:
0787 C4         490       swap a
0788 540F       491       anl a, #0x0f
078A F9         492       mov R1, a
078B 22         493            ret
078C            494   
078C            495   conv_to_bcd_low:
078C 540F       496       anl a, #0x0f
078E F8         497       mov R0, A
078F 22         498            ret
0790            499   
0790            500   conv_to_bcd:
0790 883D       501            mov x+0, R0
0792 893E       502            mov x+1, R1
0794 753F00     503            mov x+2, #0
0797 754000     504            mov x+3, #0
079A 1201C2     505       lcall hex2bcd
079D 22         506            ret
079E            507   
079E            508   Outside_tmp:
079E 53E8F0     509       anl ADCCON0, #0xF0
07A1 43E807     510            orl ADCCON0, #0x07 ; Select channel 7 
07A4            511   
07A4 C2EF       512       clr ADCF
07A6 D2EE       513       setb ADCS
07A8 30EFFD     514       jnb ADCF, $
07AB            515   
07AB E5C3       516       mov a, ADCRH
07AD C4         517       swap a
07AE C0E0       518       push acc
07B0 540F       519       anl a, #0x0f
07B2 F9         520       mov R1, a
07B3 D0E0       521       pop acc
07B5 54F0       522       anl a, #0xf0
07B7 45C2       523       orl a, ADCRL
07B9 F8         524       mov R0, A
07BA            525       
07BA            526       ; Convert to voltage
07BA 883D       527            mov x+0, R0
07BC 893E       528            mov x+1, R1
07BE 753F00     529            mov x+2, #0
07C1 754000     530            mov x+3, #0
07C4 75417C     531            mov y+0, #low (50300 % 0x10000) 
07C7 7542C4     531            mov y+1, #high(50300 % 0x10000) 
07CA 754300     531            mov y+2, #low (50300 / 0x10000) 
07CD 754400     531            mov y+3, #high(50300 / 0x10000)  ; VCC voltage measured
07D0 12033C     532            lcall mul32
07D3 7541FF     533            mov y+0, #low (4095 % 0x10000) 
07D6 75420F     533            mov y+1, #high(4095 % 0x10000) 
07D9 754300     533            mov y+2, #low (4095 / 0x10000) 
07DC 754400     533            mov y+3, #high(4095 / 0x10000)  ; 2^12-1
07DF 1203C9     534            lcall div32
07E2 7541A4     535            mov y+0, #low (27300 % 0x10000) 
07E5 75426A     535            mov y+1, #high(27300 % 0x10000) 
07E8 754300     535            mov y+2, #low (27300 / 0x10000) 
07EB 754400     535            mov y+3, #high(27300 / 0x10000) 
07EE 1202A8     536            lcall sub32
07F1 754164     537            mov y+0, #low (100 % 0x10000) 
07F4 754200     537            mov y+1, #high(100 % 0x10000) 
07F7 754300     537            mov y+2, #low (100 / 0x10000) 
07FA 754400     537            mov y+3, #high(100 / 0x10000) 
07FD 12033C     538            lcall mul32
0800            539       ;save outside temp to z to later add onto the oven temp
0800 853D45     540       mov z+0, x+0
0803 853E46     541       mov z+1, x+1
0806 853F47     542       mov z+2, x+2
0809 854048     543       mov z+3, x+3 
080C 1201C2     544       lcall hex2bcd
080F 120761     545       lcall Display_formated_BCD
0812            546            
0812 22         547            ret
0813            548   
0813            549   oven_tmp:
0813 53E8F0     550       anl  ADCCON0, #0xF0  
0816 43E804     551       orl  ADCCON0, #0x04  ; Select AIN4 (P0.5)
0819            552   
0819 C2EF       553       clr ADCF
081B D2EE       554       setb ADCS
081D 30EFFD     555       jnb ADCF, $
0820            556   
0820 E5C3       557       mov a, ADCRH
0822 C4         558       swap a
0823 C0E0       559       push acc
0825 540F       560       anl a, #0x0f
0827 F9         561       mov R1, a
0828 D0E0       562       pop acc
082A 54F0       563       anl a, #0xf0
082C 45C2       564       orl a, ADCRL
082E F8         565       mov R0, A
082F            566       
082F            567       ; Convert to voltage
082F 883D       568            mov x+0, R0
0831 893E       569            mov x+1, R1
0833 753F00     570            mov x+2, #0
0836 754000     571            mov x+3, #0
0839 75417C     572            mov y+0, #low (50300 % 0x10000) 
083C 7542C4     572            mov y+1, #high(50300 % 0x10000) 
083F 754300     572            mov y+2, #low (50300 / 0x10000) 
0842 754400     572            mov y+3, #high(50300 / 0x10000)  ; VCC voltage measured
0845 12033C     573            lcall mul32
0848 7541FF     574            mov y+0, #low (4095 % 0x10000) 
084B 75420F     574            mov y+1, #high(4095 % 0x10000) 
084E 754300     574            mov y+2, #low (4095 / 0x10000) 
0851 754400     574            mov y+3, #high(4095 / 0x10000)  ; 2^12-1
0854 1203C9     575            lcall div32
0857            576   
0857            577            ;vout of opamp should now be in x
0857            578       ;use formula vout=41uV/degC * R1/R2 --> degC = (vout*R2)/41*r1
0857            579       ;first calculate vout*R2:
0857 7541BD     580            mov y+0, #low (1469 % 0x10000) 
085A 754205     580            mov y+1, #high(1469 % 0x10000) 
085D 754300     580            mov y+2, #low (1469 / 0x10000) 
0860 754400     580            mov y+3, #high(1469 / 0x10000) 
0863 12033C     581       lcall mul32
0866            582       ;now vout*R2 ohm is in x
0866            583       ;next we will take 461 650V and divide
0866 754152     584            mov y+0, #low (461650 % 0x10000) 
0869 75420B     584            mov y+1, #high(461650 % 0x10000) 
086C 754307     584            mov y+2, #low (461650 / 0x10000) 
086F 754400     584            mov y+3, #high(461650 / 0x10000)  
0872 1203C9     585       lcall div32
0875            586       ;multiply by 100k and then divide by 41 to cancel units
0875 754140     587            mov y+0, #low (1000000 % 0x10000) 
0878 754242     587            mov y+1, #high(1000000 % 0x10000) 
087B 75430F     587            mov y+2, #low (1000000 / 0x10000) 
087E 754400     587            mov y+3, #high(1000000 / 0x10000) 
0881 12033C     588       lcall mul32
0884 754129     589            mov y+0, #low (41 % 0x10000) 
0887 754200     589            mov y+1, #high(41 % 0x10000) 
088A 754300     589            mov y+2, #low (41 / 0x10000) 
088D 754400     589            mov y+3, #high(41 / 0x10000) 
0890 1203C9     590       lcall div32
0893            591       ;move the outside temp to y and add
0893 854541     592       mov y+0, z+0
0896 854642     593       mov y+1, z+1
0899 854743     594       mov y+2, z+2
089C 854844     595       mov y+3, z+3
089F 120287     596       lcall add32
08A2 1201C2     597       lcall hex2bcd
08A5 1208AF     598       lcall display_oven_tmp
08A8 854B36     599       mov current_temp, bcd+2
08AB 854C37     600       mov current_temp_hund, bcd+3
08AE            601            ;lcall clearx
08AE            602            ;mov x, current_temp_hund
08AE            603            ;load_y(10)
08AE            604            ;lcall div32
08AE            605            ;mov current_temp_hund, x
08AE            606            
08AE            607   
08AE 22         608   ret
08AF            609   
08AF            610   display_oven_tmp:
08AF C0E0       611            push acc
08B1 7406       611            mov a, #6
08B3 14         611            dec a
08B4 120167     611            lcall ?Set_Cursor_2 ; Select column and row
08B7 D0E0       611            pop acc
08B9 C000       612            push ar0
08BB A84C       612            mov r0, bcd+3
08BD 12016E     612            lcall ?Display_BCD
08C0 D000       612            pop ar0
08C2 C000       613            push ar0
08C4 A84B       613            mov r0, bcd+2
08C6 12016E     613            lcall ?Display_BCD
08C9 D000       613            pop ar0
08CB C0E0       614            push acc
08CD 742E       614            mov a, #'.'
08CF 12011F     614            lcall ?WriteData
08D2 D0E0       614            pop acc
08D4 C000       615            push ar0
08D6 A84A       615            mov r0, bcd+1
08D8 12016E     615            lcall ?Display_BCD
08DB D000       615            pop ar0
08DD            616            
08DD C0E0       617            push acc
08DF 740F       617            mov a, #15
08E1 14         617            dec a
08E2 120167     617            lcall ?Set_Cursor_2 ; Select column and row
08E5 D0E0       617            pop acc
08E7 C000       618            push ar0
08E9 A833       618            mov r0, soak_temp_hund
08EB 12016E     618            lcall ?Display_BCD
08EE D000       618            pop ar0
08F0 C0E0       619            push acc
08F2 740D       619            mov a, #13
08F4 14         619            dec a
08F5 120167     619            lcall ?Set_Cursor_2 ; Select column and row
08F8 D0E0       619            pop acc
08FA C000       620            push ar0
08FC A837       620            mov r0, current_temp_hund
08FE 12016E     620            lcall ?Display_BCD
0901 D000       620            pop ar0
0903            621            ;display_bcd(bcd+3)
0903            622            ;Display_BCD(bcd+2)
0903            623            ;Display_char(#'.')
0903            624            ;Display_BCD(bcd+1)
0903 22         625            ret
0904            626   
0904            627   skipp1:
0904 22         628            ret
0905            629   clearx:
0905 753D00     630            mov x+0, #0x00
0908 753E00     631            mov x+1, #0x00
090B 753F00     632            mov x+2, #0x00
090E 754000     633            mov x+3, #0x00
0911 22         634            ret 
0912            635   
0912            636   check_temps:
0912 E536       637            mov a, current_temp 
0914 9532       638            subb a, Soak_temp ; subb sets carry flag if a borrow is needed (current_temp < soaktemp)
0916            639            ;soak temp is 10 for 100, current temp is 1 for 100 
0916 40EC       640            jc skipp1 ; skip if current_temp < soak_temp (carry bit set)
0918 E537       641            mov a, current_temp_hund
091A B53303     642            cjne a, soak_temp_hund, next2 ; hundreds place moves relatively slowly so can we can just use cjne
091D 753002     643            mov STATE, #0x02
0920            644   next2:
0920 22         645            ret
0921            646   
0921            647   check_currenttemp: ; TODO: apply >= comparison logic
0921 E536       648            mov a, current_temp
0923 B460DE     649            cjne a, #0x60, skipp1
0926 D208       650            setb temp_flag
0928 22         651            ret
0929            652   
0929            653   safety_feature:
0929 E539       654            mov a, seconds
092B B43CD6     655            cjne a, #0x3C, skipp1
092E 200841     656            jb temp_flag, skipp2
0931 120728     657            lcall display_blank
0934 753B00     658            mov pwm, #0
0937 C0E0       659            push acc
0939 7401       659            mov a, #1
093B 14         659            dec a
093C 120169     659            lcall ?Set_Cursor_1 ; Select column and row
093F D0E0       659            pop acc
0941 C083       660            push dph
0943 C082       660            push dpl
0945 C0E0       660            push acc
0947 900076     660            mov dptr, #safety_message
094A 12015C     660            lcall ?Send_Constant_String
094D D0E0       660            pop acc
094F D082       660            pop dpl
0951 D083       660            pop dph
0953 C0E0       661            push acc
0955 7401       661            mov a, #1
0957 14         661            dec a
0958 120167     661            lcall ?Set_Cursor_2 ; Select column and row
095B D0E0       661            pop acc
095D C083       662            push dph
095F C082       662            push dpl
0961 C0E0       662            push acc
0963 90007E     662            mov dptr, #safety_message1
0966 12015C     662            lcall ?Send_Constant_String
0969 D0E0       662            pop acc
096B D082       662            pop dpl
096D D083       662            pop dph
096F            663   
096F            664   safety_feature_loop:
096F 02096F     665            ljmp safety_feature_loop
0972            666   
0972            667   skipp2:
0972 22         668            ret
0973            669   
0973            670   ; checks secs for state 2 -> 3
0973            671   check_secs_s2:
0973 853149     672            mov bcd, soak_time ; soak_time stored as bcd
0976 12024B     673            lcall bcd2hex
0979 E53D       674       mov a, x
097B B53906     675       cjne a, seconds, skip_check_secs_s2
097E 1209D2     676            lcall debug_display
0981 753003     677       mov state, #3
0984            678   skip_check_secs_s2:
0984 22         679       ret
0985            680   
0985            681   ; checks temp for state 3 -> 4
0985            682   check_temps_s3:
0985 E536       683            mov a, current_temp 
0987 B53500     684            cjne a, Reflow_temp, nxt1
098A            685   nxt1:
098A 50E6       686            jnc skipp2
098C E537       687            mov a, current_temp_hund
098E 120905     688            lcall clearx
0991 853C3D     689            mov x,reflow_temp_100
0994 75410A     690            mov y+0, #low (10 % 0x10000) 
0997 754200     690            mov y+1, #high(10 % 0x10000) 
099A 754300     690            mov y+2, #low (10 / 0x10000) 
099D 754400     690            mov y+3, #high(10 / 0x10000) 
09A0 1203C9     691            lcall div32
09A3 853D3C     692            mov reflow_temp_100, x
09A6 B53C00     693            cjne a, reflow_temp_100, nxt2
09A9            694   nxt2:
09A9 40C7       695   jc skipp2
09AB 753004     696   mov STATe, #0x04
09AE 22         697   ret
09AF            698   
09AF            699   ; checks secs for state 4 -> 5
09AF            700   check_secs_s4:
09AF 853449     701            mov bcd, reflow_time ; reflow_time stored as bcd
09B2 12024B     702            lcall bcd2hex
09B5 E53D       703       mov a, x
09B7 B53903     704       cjne a, seconds, skip_check_secs_s4
09BA 753005     705       mov state, #5
09BD            706   skip_check_secs_s4:
09BD 22         707       ret
09BE            708   
09BE            709   ; checks temp for state 5 -> 0
09BE            710   check_temp_s5:
09BE E536       711       mov a, current_temp      
09C0 75F03C     712       mov b, #60                 
09C3 B5F003     713       cjne a, b, check_high       
09C6 0209D1     714       ljmp skip_s5_to_s0         
09C9            715   check_high:
09C9 5480       716       anl a, #0x80               ; mask msb (bit 7)
09CB 6004       717       jz skip_s5_to_s0           ; if msb = 0 skip to the end
09CD 753000     718       mov STATE, #0x00           ; set state to 0 (finished)
09D0 22         719       ret                        ; return
09D1            720   skip_s5_to_s0:
09D1 22         721       ret                        ; return without state change
09D2            722   
09D2            723   debug_display:
09D2 C0E0       724            push acc
09D4 7408       724            mov a, #8
09D6 14         724            dec a
09D7 120169     724            lcall ?Set_Cursor_1 ; Select column and row
09DA D0E0       724            pop acc
09DC C000       725            push ar0
09DE A831       725            mov r0, soak_time
09E0 12016E     725            lcall ?Display_BCD
09E3 D000       725            pop ar0
09E5 C0E0       726            push acc
09E7 7408       726            mov a, #8
09E9 14         726            dec a
09EA 120167     726            lcall ?Set_Cursor_2 ; Select column and row
09ED D0E0       726            pop acc
09EF C000       727            push ar0
09F1 A839       727            mov r0, seconds
09F3 12016E     727            lcall ?Display_BCD
09F6 D000       727            pop ar0
09F8 C0E0       728            push acc
09FA 740F       728            mov a, #15
09FC 14         728            dec a
09FD 120167     728            lcall ?Set_Cursor_2 ; Select column and row
0A00 D0E0       728            pop acc
0A02 C000       729            push ar0
0A04 A830       729            mov r0, STATE
0A06 12016E     729            lcall ?Display_BCD
0A09 D000       729            pop ar0
0A0B 22         730   ret
0A0C            731   
0A0C            732   main:
0A0C 75817F     733            mov sp, #0x7f
0A0F 120432     734            lcall Init_All
0A12 120129     735       lcall LCD_4BIT
0A15 1204AE     736            lcall Timer2_ISR
0A18            737       
0A18            738        ; initial messages in LCD
0A18 753000     739       mov STATE, #0x00
0A1B 753100     740       mov Soak_time, #0x00
0A1E 753200     741       mov Soak_temp, #0x00
0A21 753300     742       mov soak_temp_hund, #0x00
0A24 753400     743       mov Reflow_time, #0x00
0A27 753500     744       mov Reflow_temp, #0x00
0A2A 753600     745       mov current_temp, #0x00
0A2D 753700     746       mov current_temp_hund, #0x00
0A30 753900     747       mov seconds, #0x00
0A33 753A00     748       mov pwm_counter, #0x00
0A36 753B00     749       mov pwm, #0x00
0A39 753C00     750       mov reflow_temp_100, #0x00
0A3C C205       751       clr decrement1
0A3E C206       752       clr s_flag 
0A40            753            
0A40            754   Forever:
0A40 120728     755            lcall display_blank
0A43            756   
0A43            757   state_0:
0A43 C0E0       758            push acc
0A45 7401       758            mov a, #1
0A47 14         758            dec a
0A48 120169     758            lcall ?Set_Cursor_1 ; Select column and row
0A4B D0E0       758            pop acc
0A4D C083       759            push dph
0A4F C082       759            push dpl
0A51 C0E0       759            push acc
0A53 90002E     759            mov dptr, #soak_param
0A56 12015C     759            lcall ?Send_Constant_String
0A59 D0E0       759            pop acc
0A5B D082       759            pop dpl
0A5D D083       759            pop dph
0A5F C0E0       760            push acc
0A61 7401       760            mov a, #1
0A63 14         760            dec a
0A64 120167     760            lcall ?Set_Cursor_2 ; Select column and row
0A67 D0E0       760            pop acc
0A69 C083       761            push dph
0A6B C082       761            push dpl
0A6D C0E0       761            push acc
0A6F 90003D     761            mov dptr, #reflow_param
0A72 12015C     761            lcall ?Send_Constant_String
0A75 D0E0       761            pop acc
0A77 D082       761            pop dpl
0A79 D083       761            pop dph
0A7B            762   
0A7B            763   state_0_loop:
0A7B E530       764            mov a, STATE
0A7D 753B64     765           mov pwm, #100
0A80 B4000F     766            cjne a, #0, state_1
0A83 1204CF     767            lcall LCD_PB
0A86 12052D     768            lcall check_decrement
0A89 120641     769            lcall display_menu
0A8C 120622     770            lcall Check_start
0A8F 020A7B     771            ljmp state_0_loop
0A92            772   
0A92            773   state_1: 
0A92 120728     774            lcall display_blank
0A95 753900     775            mov seconds, #0x00
0A98 C0E0       776            push acc
0A9A 7401       776            mov a, #1
0A9C 14         776            dec a
0A9D 120169     776            lcall ?Set_Cursor_1 ; Select column and row
0AA0 D0E0       776            pop acc
0AA2 C083       777            push dph
0AA4 C082       777            push dpl
0AA6 C0E0       777            push acc
0AA8 90004E     777            mov dptr, #heating_to_s
0AAB 12015C     777            lcall ?Send_Constant_String
0AAE D0E0       777            pop acc
0AB0 D082       777            pop dpl
0AB2 D083       777            pop dph
0AB4 C0E0       778            push acc
0AB6 7401       778            mov a, #1
0AB8 14         778            dec a
0AB9 120167     778            lcall ?Set_Cursor_2 ; Select column and row
0ABC D0E0       778            pop acc
0ABE C083       779            push dph
0AC0 C082       779            push dpl
0AC2 C0E0       779            push acc
0AC4 90005E     779            mov dptr, #heating_temp
0AC7 12015C     779            lcall ?Send_Constant_String
0ACA D0E0       779            pop acc
0ACC D082       779            pop dpl
0ACE D083       779            pop dph
0AD0            780   
0AD0 C0E0       781            push acc
0AD2 7404       781            mov a, #4
0AD4 14         781            dec a
0AD5 120169     781            lcall ?Set_Cursor_1 ; Select column and row
0AD8 D0E0       781            pop acc
0ADA C000       782            push ar0
0ADC A833       782            mov r0, Soak_temp_hund
0ADE 12016E     782            lcall ?Display_BCD
0AE1 D000       782            pop ar0
0AE3 C0E0       783            push acc
0AE5 7405       783            mov a, #5
0AE7 14         783            dec a
0AE8 120169     783            lcall ?Set_Cursor_1 ; Select column and row
0AEB D0E0       783            pop acc
0AED C000       784            push ar0
0AEF A832       784            mov r0, soak_temp
0AF1 12016E     784            lcall ?Display_BCD
0AF4 D000       784            pop ar0
0AF6            785   
0AF6 120905     786            lcall clearx
0AF9 85333D     787            mov x, soak_temp_hund
0AFC 75410A     788            mov y+0, #low (10 % 0x10000) 
0AFF 754200     788            mov y+1, #high(10 % 0x10000) 
0B02 754300     788            mov y+2, #low (10 / 0x10000) 
0B05 754400     788            mov y+3, #high(10 / 0x10000) 
0B08 1203C9     789            lcall div32
0B0B 853D33     790            mov soak_temp_hund, x
0B0E            791   state_1_loop:
0B0E E530       792            mov a, STATE
0B10 B4011D     793            cjne a, #1, state_2
0B13 1206B4     794            lcall display_heating_s
0B16 753B00     795            mov pwm, #0
0B19 12079E     796            lcall outside_tmp
0B1C 120813     797            lcall oven_tmp
0B1F 120921     798            lcall check_currenttemp
0B22 120929     799            lcall safety_feature
0B25 120912     800            lcall check_temps
0B28 7AFA       801            mov R2, #250
0B2A 1204A8     802            lcall waitms
0B2D 020B0E     803            ljmp state_1_loop
0B30            804   
0B30            805   state_2:
0B30 120728     806            lcall display_blank 
0B33 753900     807            mov seconds, #0x00
0B36 C0E0       808            push acc
0B38 7401       808            mov a, #1
0B3A 14         808            dec a
0B3B 120169     808            lcall ?Set_Cursor_1 ; Select column and row
0B3E D0E0       808            pop acc
0B40 C083       809            push dph
0B42 C082       809            push dpl
0B44 C0E0       809            push acc
0B46 90008C     809            mov dptr, #soaking
0B49 12015C     809            lcall ?Send_Constant_String
0B4C D0E0       809            pop acc
0B4E D082       809            pop dpl
0B50 D083       809            pop dph
0B52 C0E0       810            push acc
0B54 7401       810            mov a, #1
0B56 14         810            dec a
0B57 120167     810            lcall ?Set_Cursor_2 ; Select column and row
0B5A D0E0       810            pop acc
0B5C C083       811            push dph
0B5E C082       811            push dpl
0B60 C0E0       811            push acc
0B62 9000A7     811            mov dptr, #time
0B65 12015C     811            lcall ?Send_Constant_String
0B68 D0E0       811            pop acc
0B6A D082       811            pop dpl
0B6C D083       811            pop dph
0B6E C0E0       812            push acc
0B70 740E       812            mov a, #14
0B72 14         812            dec a
0B73 120169     812            lcall ?Set_Cursor_1 ; Select column and row
0B76 D0E0       812            pop acc
0B78 C000       813            push ar0
0B7A A831       813            mov r0, soak_time
0B7C 12016E     813            lcall ?Display_BCD
0B7F D000       813            pop ar0
0B81            814   
0B81            815   state_2_loop: 
0B81 E530       816            mov a, STATE
0B83 B40225     817       cjne a, #2, state_3
0B86 C0E0       818            push acc
0B88 7406       818            mov a, #6
0B8A 14         818            dec a
0B8B 120167     818            lcall ?Set_Cursor_2 ; Select column and row
0B8E D0E0       818            pop acc
0B90 120905     819            lcall clearx
0B93 85393D     820            mov x, seconds 
0B96 1201C2     821            lcall hex2bcd 
0B99 C000       822            push ar0
0B9B A849       822            mov r0, bcd
0B9D 12016E     822            lcall ?Display_BCD
0BA0 D000       822            pop ar0
0BA2 753B14     823            mov pwm, #20
0BA5 120973     824            lcall check_secs_s2
0BA8 020B81     825            ljmp state_2_loop
0BAB            826   
0BAB            827   state_3:
0BAB 120728     828            lcall display_blank
0BAE C0E0       829            push acc
0BB0 7401       829            mov a, #1
0BB2 14         829            dec a
0BB3 120169     829            lcall ?Set_Cursor_1 ; Select column and row
0BB6 D0E0       829            pop acc
0BB8 C083       830            push dph
0BBA C082       830            push dpl
0BBC C0E0       830            push acc
0BBE 9000B0     830            mov dptr, #heating_to_r
0BC1 12015C     830            lcall ?Send_Constant_String
0BC4 D0E0       830            pop acc
0BC6 D082       830            pop dpl
0BC8 D083       830            pop dph
0BCA C0E0       831            push acc
0BCC 7401       831            mov a, #1
0BCE 14         831            dec a
0BCF 120167     831            lcall ?Set_Cursor_2 ; Select column and row
0BD2 D0E0       831            pop acc
0BD4 C083       832            push dph
0BD6 C082       832            push dpl
0BD8 C0E0       832            push acc
0BDA 90005E     832            mov dptr, #heating_temp
0BDD 12015C     832            lcall ?Send_Constant_String
0BE0 D0E0       832            pop acc
0BE2 D082       832            pop dpl
0BE4 D083       832            pop dph
0BE6            833   
0BE6            834   state_3_loop:
0BE6 E530       835            mov a, STATE
0BE8 B40317     836            cjne a, #3, state_4
0BEB 1206DB     837            lcall display_heating_r
0BEE 753B00     838            mov pwm, #0
0BF1 12079E     839            lcall outside_tmp
0BF4 120813     840            lcall oven_tmp
0BF7 120985     841            lcall check_temps_s3
0BFA 7AFA       842            mov R2, #250
0BFC 1204A8     843            lcall waitms
0BFF 020BE6     844            ljmp state_3_loop
0C02            845   
0C02            846   state_4:
0C02 120728     847            lcall display_blank 
0C05 753900     848            mov seconds, #0x00
0C08 C0E0       849            push acc
0C0A 7401       849            mov a, #1
0C0C 14         849            dec a
0C0D 120169     849            lcall ?Set_Cursor_1 ; Select column and row
0C10 D0E0       849            pop acc
0C12 C083       850            push dph
0C14 C082       850            push dpl
0C16 C0E0       850            push acc
0C18 90009A     850            mov dptr, #reflow
0C1B 12015C     850            lcall ?Send_Constant_String
0C1E D0E0       850            pop acc
0C20 D082       850            pop dpl
0C22 D083       850            pop dph
0C24 C0E0       851            push acc
0C26 7401       851            mov a, #1
0C28 14         851            dec a
0C29 120167     851            lcall ?Set_Cursor_2 ; Select column and row
0C2C D0E0       851            pop acc
0C2E C083       852            push dph
0C30 C082       852            push dpl
0C32 C0E0       852            push acc
0C34 9000A7     852            mov dptr, #time
0C37 12015C     852            lcall ?Send_Constant_String
0C3A D0E0       852            pop acc
0C3C D082       852            pop dpl
0C3E D083       852            pop dph
0C40 C0E0       853            push acc
0C42 740E       853            mov a, #14
0C44 14         853            dec a
0C45 120169     853            lcall ?Set_Cursor_1 ; Select column and row
0C48 D0E0       853            pop acc
0C4A C000       854            push ar0
0C4C A834       854            mov r0, reflow_time
0C4E 12016E     854            lcall ?Display_BCD
0C51 D000       854            pop ar0
0C53            855   
0C53            856   state_4_loop:
0C53 E530       857       mov a, STATE
0C55 B40422     858       cjne a, #4, state_5
0C58 C0E0       859            push acc
0C5A 7406       859            mov a, #6
0C5C 14         859            dec a
0C5D 120167     859            lcall ?Set_Cursor_2 ; Select column and row
0C60 D0E0       859            pop acc
0C62 85393D     860       mov x, seconds
0C65 1201C2     861       lcall hex2bcd
0C68 C000       862            push ar0
0C6A A849       862            mov r0, bcd
0C6C 12016E     862            lcall ?Display_BCD
0C6F D000       862            pop ar0
0C71 753B14     863       mov pwm, #20
0C74 1209AF     864       lcall check_secs_s4
0C77 020C53     865       ljmp state_4_loop
0C7A            866   
0C7A            867   state_5:
0C7A 120728     868       lcall display_blank
0C7D C0E0       869            push acc
0C7F 7401       869            mov a, #1
0C81 14         869            dec a
0C82 120169     869            lcall ?Set_Cursor_1 ; Select column and row
0C85 D0E0       869            pop acc
0C87 C083       870            push dph
0C89 C082       870            push dpl
0C8B C0E0       870            push acc
0C8D 9000C0     870            mov dptr, #cooling
0C90 12015C     870            lcall ?Send_Constant_String
0C93 D0E0       870            pop acc
0C95 D082       870            pop dpl
0C97 D083       870            pop dph
0C99 C0E0       871            push acc
0C9B 7401       871            mov a, #1
0C9D 14         871            dec a
0C9E 120167     871            lcall ?Set_Cursor_2 ; Select column and row
0CA1 D0E0       871            pop acc
0CA3 C083       872            push dph
0CA5 C082       872            push dpl
0CA7 C0E0       872            push acc
0CA9 90005E     872            mov dptr, #heating_temp
0CAC 12015C     872            lcall ?Send_Constant_String
0CAF D0E0       872            pop acc
0CB1 D082       872            pop dpl
0CB3 D083       872            pop dph
0CB5            873       
0CB5            874   state_5_loop:
0CB5 E530       875            mov a, STATE
0CB7 B40527     876            cjne a, #5, state_0_jump
0CBA 753B64     877            mov pwm, #100
0CBD C0E0       878            push acc
0CBF 7407       878            mov a, #7
0CC1 14         878            dec a
0CC2 120167     878            lcall ?Set_Cursor_2 ; Select column and row
0CC5 D0E0       878            pop acc
0CC7 C000       879            push ar0
0CC9 A836       879            mov r0, current_temp
0CCB 12016E     879            lcall ?Display_BCD
0CCE D000       879            pop ar0
0CD0 12079E     880            lcall outside_tmp
0CD3 120813     881            lcall oven_tmp
0CD6 1209BE     882            lcall check_temp_s5
0CD9 7AFA       883            mov R2, #250
0CDB 1204A8     884            lcall waitms
0CDE 020CB5     885            ljmp state_5_loop
0CE1            886   
0CE1            887   state_0_jump:
0CE1 020A43     888            ljmp state_0
0CE4            889   
0CE4            890   END
